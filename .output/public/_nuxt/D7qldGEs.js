import{V as R,_ as Z,a as N,b as ee,c as te}from"./DX7FhTPu.js";import P from"./CFBvynM1.js";import{B as L,y as K,x as y,C as j,D as Y,E as I,z,F as g,A as oe}from"./t18BpZc7.js";import{e as E,f as D,V as H}from"./9GlNMy6T.js";import{d as F,j as S,t as w,v as p,Y as A,x as t,aj as x,ah as U,ag as m,A as s,z as e,B as b,y as V,V as k,ai as q,_ as G,ak as se,P as ae,r as ne,o as J,al as B,am as re,af as ie,an as le,u as ce}from"./DdX6Kkz_.js";import"./CAQ2CxwN.js";const me=F({__name:"UserList",setup(M){const{user:d,avatarUrl:l}=L(),{currentRoom:u}=K(),v=S(()=>{var n;return((n=u.value)==null?void 0:n.members.filter(c=>c.id!==d.value.id))||[]});return(n,c)=>{var _;const r=P,f=Z;return p(),w(A,null,[c[2]||(c[2]=t("h2",{class:"title-with-dots"},"成员",-1)),t("ul",null,[(_=m(u))!=null&&_.members.find(o=>o.id===m(d).id)?(p(),x(H,{key:0,class:"member-item",rounded:"lg",variant:"tonal"},{prepend:s(()=>[e(j,{image:m(l),rounded:"lg",border:"md",color:"primary",size:"36"},null,8,["image"])]),append:s(()=>[e(R,{text:"点击：更改信息",location:"left"},{activator:s(({props:o})=>[e(y,k({icon:"",variant:"text",size:"small"},o),{default:s(()=>[e(r,{name:"material-symbols:edit-outline-rounded",size:"20"}),e(f)]),_:2},1040)]),_:1})]),default:s(()=>[e(E,null,{default:s(()=>[b(V(m(d).name),1)]),_:1}),m(d).isRoomOwner?(p(),x(D,{key:0,class:"owner-badge"},{default:s(()=>c[0]||(c[0]=[b("(房主)")])),_:1})):U("",!0)]),_:1})):U("",!0),(p(!0),w(A,null,q(m(v),(o,h)=>(p(),x(H,{key:h,class:"member-item",rounded:"lg"},{prepend:s(()=>[e(j,{image:("getMemberAvatarUrl"in n?n.getMemberAvatarUrl:m(Y))(o.avatar),rounded:"lg",border:"md",color:"primary",size:"36"},null,8,["image"])]),append:s(()=>[m(d).isRoomOwner&&o.id!==m(d).id?(p(),x(R,{key:0,text:"点击：踢出成员",location:"left"},{activator:s(({props:a})=>[e(y,k({icon:"",variant:"text",color:"error",size:"small",ref_for:!0},a),{default:s(()=>[e(r,{name:"material-symbols:exit-to-app-rounded",size:"20"})]),_:2},1040)]),_:1})):U("",!0)]),default:s(()=>[e(E,null,{default:s(()=>[b(V(o.name),1)]),_:2},1024),o.isRoomOwner?(p(),x(D,{key:0,class:"owner-badge"},{default:s(()=>c[1]||(c[1]=[b("(房主)")])),_:1})):U("",!0)]),_:2},1024))),128))])],64)}}}),de=G(me,[["__scopeId","data-v-ade4bdf6"]]),ue="chatState",$=se({messages:[]}),_e=()=>{if(typeof window>"u")return{messages:S(()=>[]),sendChat:()=>{},getChatHistory:()=>{}};ae(ue,$);const M=async l=>{I().isConnected||await z(),g.emit("sendChat",{content:l})},d=async()=>(I().isConnected||await z(),g.on("onRoomChat",l=>{$.messages=l.messages}),new Promise((l,u)=>{setTimeout(()=>{g.off("roomChats"),u(new Error("Join room timeout"))},1e4),g.once("roomChats",v=>{const n=v;$.messages=n.messages,l(v)}),g.emit("getChats")}));return{messages:S(()=>$.messages),sendChat:M,getChatHistory:d}},pe={class:"chat-list"},ve=["src"],fe={class:"sender"},ge={class:"message-time"},he={class:"message"},ye={class:"flex flex-row gap-3 w-full"},we=F({__name:"Chat",setup(M){const{sendChat:d,getChatHistory:l,messages:u}=_e(),{user:v}=L(),n=ne(""),c=()=>{n.value.trim()!==""&&(d(n.value),n.value="")};J(async()=>{await z(),await l()});const r=f=>v.value.id===f.sender.id;return(f,_)=>(p(),w(A,null,[_[2]||(_[2]=t("h2",{class:"title-with-dots"},"聊天",-1)),t("div",pe,[(p(!0),w(A,null,q(m(u),o=>(p(),w("div",{key:o.message,class:B(["chat-message",r(o)?"flex-row-reverse":""])},[t("img",{src:("getMemberAvatarUrl"in f?f.getMemberAvatarUrl:m(Y))(o.sender.avatar),class:"w-9 h-9 rounded-lg mt-0.5",alt:"avatar"},null,8,ve),t("div",{class:B(["flex flex-col max-w-[70%]",r(o)?"items-end":"items-start"])},[t("div",{class:B(["message-info flex flex-row items-end w-full gap-2",r(o)?"justify-between":""])},[t("span",fe,V(r(o)?"":o.sender.name),1),t("span",ge,V(new Date(o.timestamp).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})),1)],2),t("span",he,V(o.message),1)],2)],2))),128))]),t("div",ye,[e(N,{modelValue:m(n),"onUpdate:modelValue":_[0]||(_[0]=o=>ie(n)?n.value=o:null),variant:"outlined",density:"compact",label:"发送消息","hide-details":"",onKeyup:re(c,["enter"])},null,8,["modelValue"]),e(y,{onClick:c},{default:s(()=>_[1]||(_[1]=[b("发送")])),_:1})])],64))}}),Ce={class:"overlay-container"},xe={class:"overlay left-overlay"},be={class:"game-title"},Re={class:"overlay-card room-url-section"},Ve={class:"url-container"},ke={class:"overlay right-overlay"},ze={class:"overlay-card members-list"},Me={class:"overlay-card chat-section"},Ue=F({__name:"[code]",setup(M){const d=le(),l=ce(),u=S(()=>d.params.code),{currentRoom:v,joinRoom:n,leaveRoom:c}=K(),{user:r}=L(),{isConnected:f}=I(),_=async()=>{try{await z(),await c(),l.push("/")}catch(a){console.error("Failed to leave room:",a),alert("无法退出房间，请稍后再试。")}},o=()=>{navigator.clipboard.writeText(`https://richup.io/room/${u.value}`).then(()=>{}).catch(a=>{console.error("Failed to copy:",a)})},h=a=>{var i;r.value.isRoomOwner=((i=a.find(T=>T.id===r.value.id))==null?void 0:i.isRoomOwner)||!1};return J(async()=>{if(f.value||(console.log("socket not connected, waiting for connection"),await z()),r.value.currentRoomCode&&v.value)if(r.value.currentRoomCode!==u.value){console.log(r.value.currentRoomCode,u.value),console.log("already in room, redirecting"),await l.push(`/room/${r.value.currentRoomCode}`);return}else console.log("already in room");else{console.log("not in any room");const a=await n(u.value);a.room&&h(a.room.members)}if(!v.value){console.log("room not found"),alert("房间不存在或已关闭"),await l.push("/");return}h(v.value.members),g.on("user_joined",a=>{h(a.members)}),g.on("user_left",a=>{h(a.members)}),g.on("room_member_update",a=>{h(a.members)})}),(a,i)=>{const T=ee,Q=te,O=P,W=de,X=we;return p(),w("div",Ce,[t("div",xe,[t("div",be,[e(R,{text:"点击：关闭边栏",location:"top"},{activator:s(({props:C})=>[e(y,k({title:"点击：关闭边栏",active:!1,exact:!1,class:"game-icon",variant:"text"},C),{default:s(()=>[e(T,{alt:"site-icon",height:"24",src:"/site_icon.svg",width:"24"}),i[0]||(i[0]=t("h1",{class:"text-xl font-bold ml-3"},"东方夜雀五札戏",-1))]),_:2},1040)]),_:1}),e(oe),e(Q),e(R,{text:"点击：退出房间",location:"top"},{activator:s(({props:C})=>[e(y,k({title:"点击：退出房间",icon:!0,variant:"text",onClick:_,color:"error",size:"small"},C),{default:s(()=>[e(O,{name:"material-symbols:exit-to-app-rounded",size:"22"})]),_:2},1040)]),_:1})]),t("div",Re,[i[1]||(i[1]=t("h2",{class:"title-with-dots"},"邀请",-1)),t("div",Ve,[e(N,{type:"text",density:"compact",variant:"solo-filled","hide-details":"",value:"https://richup.io/room/"+m(u),readonly:""},null,8,["value"]),e(R,{text:"点击：复制房间链接",location:"top"},{activator:s(({props:C})=>[e(y,k({class:"!h-10",size:"small",onClick:o},C),{default:s(()=>[e(O,{name:"material-symbols:content-copy-rounded",size:"20"})]),_:2},1040)]),_:1})])]),i[2]||(i[2]=t("div",{class:"overlay-card room-settings-section grow"},[t("h2",{class:"title-with-dots"},"设置"),t("div",{class:"room-settings-container"})],-1))]),i[3]||(i[3]=t("div",{class:"game-area"},null,-1)),t("div",ke,[t("div",ze,[e(W)]),t("div",Me,[e(X)])])])}}}),Le=G(Ue,[["__scopeId","data-v-0ff09dbb"]]);export{Le as default};
